# sentry-fetch

`sentry-fetch` is a implementation of [WHATWG fetch()] that supports Sentry and
Midway authentication similar to [openid.xhr].

[WHATWG fetch()]: https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch
[openid.xhr]: https://w.amazon.com/index.php/Sentry/Regionalized_Identity/Migration/JavaScript

## Usage

Using ecma modules

```javascript
import fetch from '@amzn/sentry-fetch';

fetch('/example', { credentials: 'include' })
  .then(res => res.json)
  .then(json => console.log(json));
```

Using commonjs

```javascript
const fetch = require('@amzn/sentry-fetch').default;

fetch('/example')
  .then(res => res.json)
  .then(json => console.log(json));
```

sentry-fetch delegates to `window.fetch`, so you environment _must_ include
`window.fetch`.

### Configuration

In some **very rare cases**, you may need to override SentryFetch's default behavior. The following parameters can be set by passing a `sentryOptions` object in your `fetch` request

Example:

```js
fetch('/example', {
  sentryOptions: {
    debug: true,
    getEndpointOverride: myCustomGetEndpointOverride,
    followMidwayStepUp: true,
  }
});
```

|property|type|description|
|---|---|---|
|`debug`|`boolean`|Enables debug logging. Disabled by default.|
|`getEndpointOverride`|`(RequestInfo | URL) => string`|Sentry sso services have a /sso/login endpoint that returns returns a authn_endpoint. Normally, SentryFetch uses a regular expression to extract the first URL in the request. If you need a different behavior, provide a function which receives a Request and returns an endpoint url. SentryFetch will append `/sso/login` to this endpoint when initiating the auth flow)|
|`preserveRedirectUri`|`boolean`|Prevents replacing the `redirect-uri` query parameter in "authn_endpoint". By default the `redirect_uri` will be replaced with the target URL passed to `sentryFetch`, however the target URL domain may differ from `client_id` for which the authentication is being requesed. This flag allows a third-party service to generate the authn requests for relying parties and independently verify the tokens issued by the auth provider.|
|`failOnInvalidSession`|`boolean`|When `followMidwayStepUp` is enabled, this option allows control to be returned to the website for an invalid Midway session by cleaning up the modal and throwing the `NO_MIDWAY_SESSION_ERROR`. An invalid session occurs when the login method used is not accepted by the `client_id` and Midway refuses to issue a token even when the login was successful.|
|`followMidwayStepUp`|`boolean or string`|Automatically redirects the user to https://midway-auth.amazon.com/login with a redirect back to the page they were on in the case there is no valid Midway token. Strings can be one of ["mfa", "selective_mfa"] to use standard or selective mfa when logging in through Midway, if set to true will use the Midway default authorization level. This functionality is disabled by default.|
|`followMidwayStepUpOptions`|_(See below)_|Controls whether redirect confirmation is shown to the user or a modal is displayed that waits until the user refreshes the Midway session.|

#### followMidwayStepUpOptions

By default, if you enable `followMidwayStepUp`, the user will be automatically redirected without a warning. If you want the user to see a confirmation before being redirected, you can use:

```js
{ followMidwayStepUpOptions: { mode: 'confirm' } }
```

You can customize the message shown by using the `message` field:

```js
{
  followMidwayStepUpOptions: {
    mode: 'confirm',
    message: i18n('MIDWAY_REDIRECT_MESSAGE')
  }
}
```

Alternatively, if you don't want the users to leave your site, you can display a modal that will open a popup which will wait until the user refreshes their Midway session.

```js
{ followMidwayStepUpOptions: { mode: 'modal' } }
```

You can customize the text of the modal with:

```js
{
  followMidwayStepUpOptions: {
    mode: 'modal',
    title: i18n('MIDWAY_MODAL_TITLE'),
    body: i18n('MIDWAY_MODAL_BODY'),
    buttonText: i18n('MIDWAY_MODAL_BUTTON'),
  }
}
```

Finally, if the default modal experience or styling doesn't quite work for you, you can create your own. Simply use the `createModal` callback field:

```js
{
  followMidwayStepUpOptions: {
    mode: 'modal',
    createModal: options => {
      // these will contain the default values or the ones specified by you
      const { title, body, buttonText } = options;

      // this opens a popup so that the user can authenticate with Midway
      // you usually would invoke this on the button 'click' event
      options.openAuthWindow();

      return {
        close: () => {
          // put your cleanup logic here: remove DOM nodes, event listeners, etc
        }
      };
    }
  }
}
```

See [default-auth-modal.ts](https://code.amazon.com/packages/SentryFetch/blobs/mainline/--/src/default-auth-modal.ts) for a more complex example.

#### Pre-configure sentryFetch via the `configure` function

You may also use the configure method to return a preconfigured fetch which avoids passing your config to each request.

```js
import { configure } from 'sentry-fetch';

const fetch = configure({
  followMidwayStepUp: 'selective_mfa'
  followMidwayStepUpOptions: { mode: 'modal' }
});
```

### Well-known errors

There are a series of well-known errors that can occur while performing a fetch with `sentry-fetch`.
You can identify them by importing the `SentryError` enum as follows:

```js
import fetch, { SentryError } from 'sentry-fetch';

fetch('(...)').catch(err => {
  if (err.message === SentryError.NO_MIDWAY_SESSION) {
    // (...)
  }
});
```

The following table summarizes the well-known errors:

|key|description|
|---|-----------|
|`MIDWAY_AUTH_MODAL_FAILED`|The endpoint is protected by Midway, the user does not have a valid Midway session (i.e. they must re-authenticate using a security key), and the Midway authentication modal has failed (e.g. popups are blocked). This error only occurs when `followMidwayStepUp` and `followMidwayStepUpOptions.mode == 'modal'` are enabled.|
|`MIDWAY_REDIRECT`|The endpoint is protected by Midway, the user does not have a valid Midway session (i.e. they must re-authenticate using a security key), and the user has been redirected to Midway. This error only occurs when `followMidwayStepUp` is enabled.|
|`MIDWAY_REDIRECT_CANCELLED`|The endpoint is protected by Midway, the user does not have a valid Midway session (i.e. they must re-authenticate using a security key), and the user has cancelled the redirect to Midway. This error only occurs when `followMidwayStepUp` and `followMidwayStepUpOptions.mode == 'confirm'` are enabled.|
|`NO_MIDWAY_SESSION`|The endpoint is protected by Midway and the user does not have a valid Midway session (i.e. they must re-authenticate using a security key). This error only occurs when `followMidwayStepUp` is disabled or when `failOnInvalidSession` is enabled.|

## Changelog

### 2.1.8

- Commit `package-lock.json` with `@types/babel__traverse==7.17.1` to fix
  [typescript compile issues](https://build.amazon.com/log?nbtmTaskId=79b21eec246c720d7770ef5e17139181246a392b4fdb38ee6b6d98f3e7d68429&backToRequestId=6248189424&attemptId=1).

### 2.1.7

- Add URL to function signatures currently taking RequestInfo. See https://github.com/microsoft/TypeScript-DOM-lib-generator/issues/1016. Internally call URL.toString() to make URL acceptable as RequestInfo, rather than upgrading to TS 4.4+ to use the DOM lib.

### 2.1.6

- Fixed infinite loop when overriding window.fetch that was introduced in 2.1.5

### 2.1.5

- Add option to fail when the authenticated session is invalid.

### 2.1.4
 - Do not attempt to re-authenticate when request was aborted
 - Add option to preserve redirect_uri in auth endpoint

### 2.1.3
 - Added Midway redirect confirmation.
 - Added Midway authentication modal dialog.
 - Added `MIDWAY_AUTH_MODAL_FAILED`, `MIDWAY_REDIRECT`, and `MIDWAY_REDIRECT_CANCELLED` well-known errors.

### 2.1.2
 - Fixed bug when session storage and token cookie are out-of-sync.
 - Added `debug` field to `sentryOptions`.

### 2.1.1
 - Optimization of cookie-token validity cache (cache on first request).
 - Optimization of retries (disable retry of non-retryable errors).
 - Introduction of well-known errors.

### 2.1.0
 - Allow login through Midway when user doesn't have a token

### 1.1
 - Support [Request] object parameters.
 - Build for es6 and es5.
 - Include type definitions for typescript.

 [Request]: https://w.amazon.com/index.php/Sentry/Regionalized_Identity/Migration/JavaScript

## Published
to live and npm shared CodeArtefact repo

### How-to publish a new version
Note: publish will fail unless the version in package.json is bumped!

Pre-setup:
```
toolbox install ada
```

https://builderhub.corp.amazon.com/docs/codeartifact/user-guide/installing.html#installing-aws-cli-extension


```
ada credentials update --account=285341719387 --provider=conduit --role=Admin --profile=285341719387 (in a new window)
(If Admin is not authorized, try --role=IibsAdminAccess-DO-NOT-DELETE)
```
```
aws goshawk get-login --package-manager npm --domain-name amazon --repository-name shared --execute --region us-west-2 --profile 285341719387
(If you are using aws-cli 2.0, you might hit error "goshawk is not a valid choice". Try the sage post for solution https://sage.amazon.com/posts/903197)
npm publish
```

Voila, now your pure NAWS consumers can consume this version.
